name: Clang-Tidy

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    clang-tidy:
        runs-on: ubuntu-latest

        env:
            CMAKE_BUILD_TYPE: Debug

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install toolchain and libs
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    clang clang-tidy cmake ninja-build \
                    qt6-base-dev qt6-declarative-dev qt6-tools-dev qt6-tools-dev-tools \
                    libgl1-mesa-dev \
                    libgtest-dev

                  # Build and install GoogleTest so that CMake's GTest CONFIG package is available
                  if [ -d /usr/src/googletest/googletest ]; then
                    sudo cmake -S /usr/src/googletest/googletest -B /tmp/gtest-build
                  elif [ -d /usr/src/gtest ]; then
                    sudo cmake -S /usr/src/gtest -B /tmp/gtest-build
                  else
                    echo "No GoogleTest sources found under /usr/src"
                    exit 1
                  fi
                  sudo cmake --build /tmp/gtest-build --target install

            - name: Configure (CMake, generate compile_commands.json)
              run: |
                  cmake -S . -B build \
                    -G Ninja \
                    -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
                    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
                    -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/cmake/Qt6

            - name: Run clang-tidy
              run: |
                  mapfile -t Files < <(find . -path ./build -prune -o -name '*.cpp' -print)

                  if [ ${#Files[@]} -eq 0 ]; then
                    echo "No .cpp files found."
                    exit 0
                  fi

                  clang-tidy \
                    -p build \
                    "${Files[@]}"
